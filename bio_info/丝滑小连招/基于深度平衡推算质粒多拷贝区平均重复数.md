## 🥊 招式背景
当遇到质粒中存在大片段串联重复（如 10x 以上的重复区），组装软件往往难以给出确切的平均拷贝数。此时通过手动构建不同重复倍数（如 11x, 12x, 13x）的参考序列，回比 Reads 并计算单/多拷贝区的深度比值（Ratio），寻找最接近 1.0 的平衡点，是判定真实平均拷贝数的较有说服力的手段。

## 🛠️ 前置准备

参考`完整基因组Mapping后抽取单个Contig序列BAM.md`获取质粒bam，然后`samtools index`创建质粒bam的索引。

*   **工具**：`samtools` (v1.10+), `bc` (用于浮点运算)
*   **环境**：建议在 Conda 生信环境下运行。
*   **占位符说明**：
    *   `/path/to/bams/`：存放不同版本 BAM 的目录。
    *   `LEFT_END`：单拷贝区（非重复区）的末尾坐标。
    *   `RIGHT_START`：多拷贝区（重复区）的起始坐标。

## 📜 出招表 (The Combo)

**第一步：单样测试（验证动态长度逻辑）**
```bash
# 获取参考序列名称和总长度（动态适配不同倍数的参考序列）
REF_INFO=$(samtools view -H target.bam | grep "^@SQ" | head -n 1)
REF_NAME=$(echo "$REF_INFO" | cut -f2 | sed 's/SN://')
REF_LEN=$(echo "$REF_INFO" | cut -f3 | sed 's/LN://')

# 统计两个区域的平均深度（不建议过滤 MapQ，因为重复区 Read 会有 MapQ=0）
# 建议坐标适当缩进 50bp 以规避接合处效应
left_mean=$(samtools depth -aa -r "${REF_NAME}:1-950" target.bam | awk '{sum+=$3} END {print sum/NR}')
right_mean=$(samtools depth -aa -r "${REF_NAME}:1050-${REF_LEN}" target.bam | awk '{sum+=$3} END {print sum/NR}')

# 计算 Ratio
echo "scale=3; $right_mean / $left_mean" | bc
```

**第二步：全量验收（批量对比）**
```bash
# 遍历目录下的所有 BAM，输出对比矩阵
printf "BAM\tRatio\tStatus\n"
for bam in *.bam; do
    # ...执行上述统计逻辑...
    # 判定逻辑：Ratio > 1 (参考序列短了); Ratio < 1 (参考序列长了)
done
```
